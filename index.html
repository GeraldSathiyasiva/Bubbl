<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>bubbl ‚Äî Laundry Pickup & Delivery</title>
  <meta name="description" content="Order laundry pickup & delivery. Live pricing, Google Maps address, and in‚Äëapp checkout.">
  <style>
    :root { color-scheme: light dark; --bg:#0f1115; --panel:#121826; --muted:#9aa4b2; --accent:#3b82f6; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444; --shadow: 0 10px 30px rgba(0,0,0,.25); }
    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; background: var(--bg); color:#fff; }
    header { position: sticky; top:0; z-index:10; backdrop-filter: blur(10px); background:rgba(17,24,39,.75); border-bottom:1px solid rgba(255,255,255,.06); }
    .wrap { max-width:1200px; margin:0 auto; padding:16px; }
    h1 { font-size: clamp(20px, 3vw, 32px); margin:4px 0; }
    h2 { font-size:20px; margin:16px 0 8px; }
    p.sub { color: var(--muted); margin:0; }
    .grid { display:grid; grid-template-columns: 1.1fr .9fr; gap:16px; }
    .card { background: var(--panel); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:16px; box-shadow: var(--shadow); }
    #map { height: 460px; border-radius:12px; }
    .row { display:flex; gap:8px; align-items:center; }
    .row > * { flex:1; }
    label { font-size:13px; color: #cbd5e1; display:block; margin:6px 0 4px; }
    input[type="text"], input[type="tel"], input[type="number"], input[type="datetime-local"], select, textarea { width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.1); background:#0d1220; color:#fff; }
    textarea { min-height:68px; }
    .muted { color: var(--muted); font-size:12px; }
    .btn { display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 14px; border-radius:999px; border:1px solid transparent; background: var(--accent); color:#fff; cursor:pointer; font-weight:600; text-decoration:none; }
    .btn.secondary { background:transparent; border-color: rgba(255,255,255,.18); }
    .btn.ghost { background:transparent; color:#fff; }
    .btn:disabled { opacity:.5; cursor:not-allowed; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#1f2937; color:#cbd5e1; font:12px ui-monospace; margin-right:6px; }
    .divider { height:1px; background: rgba(255,255,255,.08); margin:12px 0; }
    table { width:100%; border-collapse:collapse; }
    th, td { text-align:left; padding:8px; border-bottom:1px dashed rgba(255,255,255,.08); }
    tfoot td { border-bottom:none; }
    .right { text-align:right; }
    .warn { color: var(--warn); }
    .err { color: var(--err); }
    .ok { color: var(--ok); }
    .stack { display:flex; flex-direction:column; gap:12px; }
    .items { display:flex; gap:8px; flex-wrap:wrap; }
    .item { display:flex; gap:8px; align-items:center; padding:8px 10px; border:1px solid rgba(255,255,255,.12); border-radius:10px; background: #0d1220; }
    .qty { width:64px; }

    @media (max-width: 960px) { .grid { grid-template-columns: 1fr; } #map { height: 360px; } }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>üß∫ bubbl</h1>
      <p class="sub">Laundry pickup & delivery ‚Ä¢ Google Maps address ‚Ä¢ Live pricing ‚Ä¢ In‚Äëapp checkout</p>
    </div>
  </header>

  <main class="wrap" style="padding-top:16px; padding-bottom:40px;">
    <div class="grid">
      <!-- LEFT: Map & Address -->
      <section class="card">
        <h2>1) Set your pickup address</h2>
        <div class="row">
          <div>
            <label for="search">Search address / building</label>
            <div class="row">
              <input id="search" type="text" placeholder="Start typing your address‚Ä¶" />
              <button class="btn secondary" id="btnUsePin">Use map pin</button>
            </div>
            <div class="muted">Autocomplete powered by Google Places. Drag the pin if needed.</div>
          </div>
          <div>
            <label>Distance from base <span class="muted">(Bangsar / PJ)</span></label>
            <div><span class="pill" id="distanceKm">‚Äî km</span> <span class="pill" id="inArea">Checking‚Ä¶</span></div>
            <div class="muted">Service radius <span id="radiusKm">‚Äî</span> km.</div>
          </div>
        </div>
        <div id="map"></div>
        <div class="row" style="margin-top:10px;">
          <div>
            <label for="addr">Selected address</label>
            <input id="addr" type="text" placeholder="Address" />
          </div>
          <div>
            <label for="latlng">Lat,Lng</label>
            <input id="latlng" type="text" placeholder="3.1692,101.6118" />
          </div>
        </div>
      </section>

      <!-- RIGHT: Customer & Order -->
      <section class="card">
        <h2>2) Your details</h2>
        <div class="row">
          <div>
            <label for="custName">Full name</label>
            <input id="custName" type="text" placeholder="Your name" />
          </div>
          <div>
            <label for="custPhone">Phone</label>
            <input id="custPhone" type="tel" placeholder="e.g., 60123456789" />
          </div>
        </div>
        <div class="row">
          <div>
            <label for="pickupAt">Preferred pickup</label>
            <input id="pickupAt" type="datetime-local" />
          </div>
          <div>
            <label for="notes">Notes for rider</label>
            <input id="notes" type="text" placeholder="Gate code, unit number, special care, etc." />
          </div>
        </div>
        <div class="divider"></div>
        <h2>3) Order & pricing</h2>
        <div class="row">
          <div>
            <label for="service">Service</label>
            <select id="service">
              <option value="washfold">Wash & Fold (per kg)</option>
              <option value="ironing">Ironing (per item)</option>
              <option value="dryclean">Dry Cleaning (per item)</option>
            </select>
          </div>
        </div>

        <!-- Wash & Fold block -->
        <div id="block-washfold" class="stack" style="margin-top:8px;">
          <div class="row">
            <div>
              <label for="kg">Weight (kg)</label>
              <input id="kg" type="number" min="1" step="0.5" value="5" />
              <div class="muted">Rate: <span id="rateKg">‚Äî</span> / kg ‚Ä¢ Min order: <span id="minOrder">‚Äî</span></div>
            </div>
            <div>
              <label for="fragile">Separate delicates?</label>
              <select id="fragile"><option>No</option><option>Yes</option></select>
            </div>
          </div>
        </div>

        <!-- Per-item blocks -->
        <div id="block-items" class="stack" style="display:none; margin-top:8px;">
          <div class="items" id="items"></div>
          <div class="row">
            <button class="btn secondary" id="addItem">+ Add custom item</button>
            <span class="muted">Tap + / ‚Äì to adjust quantities.</span>
          </div>
        </div>

        <div class="divider"></div>
        <table>
          <thead>
            <tr><th>Line item</th><th class="right">Amount</th></tr>
          </thead>
          <tbody id="lines"></tbody>
          <tfoot>
            <tr><td class="right">Pickup fee</td><td class="right" id="pickupFee">‚Äî</td></tr>
            <tr><td class="right"><strong>Total</strong></td><td class="right" id="grand"><strong>‚Äî</strong></td></tr>
          </tfoot>
        </table>

        <div class="row" style="margin-top:10px;">
          <button class="btn" id="btnSubmit">üß∫ Submit order</button>
          <button class="btn secondary" id="btnCopyJson">Copy order JSON</button>
        </div>
        <div class="muted" id="submitStatus" style="margin-top:6px;">No payment collected here. Totals are estimates; final bill confirmed after weighing/inspection.</div>
      </section>
    </div>

    <section class="card" style="margin-top:16px;">
      <h2>Pricing</h2>
      <div class="row">
        <div>
          <div class="pill">Wash & Fold: <span id="p_wf"></span> / kg</div>
          <div class="pill">Ironing: from <span id="p_ir"></span> / item</div>
          <div class="pill">Pickup base: <span id="p_pb"></span>, then <span id="p_pk"></span> / km</div>
          <div class="pill">Min order: <span id="p_min"></span></div>
        </div>
        <div>
          <div class="muted">Dry-clean guide (each): Shirt <span id="p_dc_shirt"></span>, Pants <span id="p_dc_pants"></span>, Dress <span id="p_dc_dress"></span>, Suit <span id="p_dc_suit"></span>, Bedsheet <span id="p_dc_sheet"></span></div>
        </div>
      </div>
    </section>

    <footer class="wrap" style="text-align:center; margin-top:16px; color:#94a3b8;">
      <small>¬© <span id="year"></span> <span id="bizName"></span> ‚Ä¢ Built with Google Maps Platform ‚Ä¢ <a class="btn ghost" href="#" id="reset">Reset</a></small>
    </footer>
  </main>

  <!-- Google Maps JS API: replace YOUR_GOOGLE_MAPS_API_KEY. We use Places + Geometry libraries. -->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&libraries=places,geometry&callback=initMap"></script>

  <script>
    // --- CONFIG ---
    const CONFIG = {
      business: {
        name: "bubbl",
        base: { lat: 3.1692, lng: 101.6118, label: "Bangsar / PJ" },
        serviceRadiusKm: 12
      },
      pricing: {
        currency: "MYR",
        symbol: "RM",
        washFoldPerKg: 10.0,
        ironingPerItem: 1.0,
        dryClean: { Shirt: 8, Pants: 10, Dress: 15, Suit: 35, Bedsheet: 12 },
        pickupFeeBase: 2.0,
        pickupFeeFreeKm: 0,
        pickupFeePerKm: 0.5,
        minOrder: 30,
        promoCodes: { }
      },
      backend: { submitUrl: "https://your-backend.example.com/api/orders" },
      ui: { locale: "en-MY" }
    };

    // --- helpers ---
    const fmt = new Intl.NumberFormat(CONFIG.ui.locale || 'en-MY', { style: 'currency', currency: CONFIG.pricing.currency });
    const money = v => { try { return fmt.format(v); } catch(e) { return `${CONFIG.pricing.symbol} ${(+v).toFixed(2)}`; } };
    const q = sel => document.querySelector(sel);
    const round2 = v => Math.round((v + Number.EPSILON) * 100) / 100;

    // --- state ---
    const state = {
      pos: { lat: CONFIG.business.base.lat, lng: CONFIG.business.base.lng },
      address: '',
      service: 'washfold',
      kg: 5,
      items: {},
      fragile: 'No'
    };

    // --- Google Maps objects ---
    let gmap, gmarker, gcircle, geocoder, autocomplete;

    // initMap is the Google callback
    function initMap(){
      q('#radiusKm').textContent = CONFIG.business.serviceRadiusKm;

      geocoder = new google.maps.Geocoder();
      gmap = new google.maps.Map(document.getElementById('map'), {
        center: { lat: CONFIG.business.base.lat, lng: CONFIG.business.base.lng },
        zoom: 13,
        mapTypeControl: false,
        fullscreenControl: false,
      });

      // circle (service radius)
      gcircle = new google.maps.Circle({
        strokeColor: '#3b82f6', strokeOpacity: 0.9, strokeWeight: 1,
        fillColor: '#3b82f6', fillOpacity: 0.1,
        map: gmap,
        center: CONFIG.business.base,
        radius: CONFIG.business.serviceRadiusKm * 1000
      });

      // marker
      gmarker = new google.maps.Marker({
        position: state.pos,
        map: gmap,
        draggable: true,
        title: 'Pickup location'
      });

      gmarker.addListener('dragend', async ()=> {
        const p = gmarker.getPosition();
        state.pos = { lat: p.lat(), lng: p.lng() };
        q('#latlng').value = `${state.pos.lat.toFixed(6)}, ${state.pos.lng.toFixed(6)}`;
        await reverseGeocode(state.pos);
        recalc();
      });

      gmap.addListener('click', async (e)=>{
        gmarker.setPosition(e.latLng);
        state.pos = { lat: e.latLng.lat(), lng: e.latLng.lng() };
        q('#latlng').value = `${state.pos.lat.toFixed(6)}, ${state.pos.lng.toFixed(6)}`;
        await reverseGeocode(state.pos);
        recalc();
      });

      // Places Autocomplete
      const input = document.getElementById('search');
      autocomplete = new google.maps.places.Autocomplete(input, { fields: ['geometry','formatted_address','name'] });
      autocomplete.addListener('place_changed', ()=>{
        const place = autocomplete.getPlace();
        if(!place.geometry) return;
        const loc = place.geometry.location;
        const lat = loc.lat(), lng = loc.lng();
        state.pos = { lat, lng };
        gmap.setCenter(loc);
        gmap.setZoom(15);
        gmarker.setPosition(loc);
        q('#addr').value = place.formatted_address || place.name || '';
        q('#latlng').value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        recalc();
      });

      // Use pin button
      q('#btnUsePin').onclick = async ()=>{
        const p = gmarker.getPosition();
        state.pos = { lat: p.lat(), lng: p.lng() };
        q('#latlng').value = `${state.pos.lat.toFixed(6)}, ${state.pos.lng.toFixed(6)}`;
        await reverseGeocode(state.pos);
        recalc();
      };

      // defaults
      q('#latlng').value = `${state.pos.lat.toFixed(6)}, ${state.pos.lng.toFixed(6)}`;
      reverseGeocode(state.pos);
      syncUIFromConfig();
      buildItemChips();
      bindEvents();
      switchBlocks();
      recalc();
    }

    async function reverseGeocode(pos){
      return new Promise((resolve)=>{
        geocoder.geocode({ location: pos }, (results, status)=>{
          if(status === 'OK' && results && results[0]){
            q('#addr').value = results[0].formatted_address;
          }
          resolve();
        });
      });
    }

    function haversineKmGoogle(a, b){
      const p1 = new google.maps.LatLng(a.lat, a.lng);
      const p2 = new google.maps.LatLng(b.lat, b.lng);
      const meters = google.maps.geometry.spherical.computeDistanceBetween(p1, p2);
      return Math.round((meters/1000) * 100) / 100; // 2dp
    }

    // pricing helpers
    function pickupFeeForDistance(km){
      const { pickupFeeBase, pickupFeeFreeKm, pickupFeePerKm } = CONFIG.pricing;
      const extraKm = Math.max(0, km - pickupFeeFreeKm);
      return round2(pickupFeeBase + extraKm * pickupFeePerKm);
    }

    function buildLines(){
      const lines = [];
      if(state.service === 'washfold'){
        const qty = Math.max(0, parseFloat(q('#kg').value||'0'));
        state.kg = qty;
        const rate = CONFIG.pricing.washFoldPerKg;
        const base = round2(qty * rate);
        const min = CONFIG.pricing.minOrder;
        const final = round2(Math.max(base, min));
        lines.push([`Wash & Fold ‚Äî ${qty} kg @ ${money(rate)} / kg`, final]);
        if(final === min) lines.push([`Min order top-up`, 0]);
        if(q('#fragile').value === 'Yes') lines.push([`Delicates (separate bag)`, 0]);
      } else {
        const dict = state.items;
        const priceMap = state.service === 'ironing' ? null : CONFIG.pricing.dryClean;
        const perItemDefault = state.service === 'ironing' ? CONFIG.pricing.ironingPerItem : 0;
        let subtotal = 0, count = 0;
        Object.entries(dict).forEach(([name, qty])=>{
          if(!qty) return;
          const unit = state.service === 'ironing' ? (perItemDefault) : (priceMap[name] || 0);
          const lineAmt = round2(unit * qty);
          subtotal += lineAmt; count += qty;
          lines.push([`${name} √ó ${qty} @ ${money(unit)}`, lineAmt]);
        });
        if(count===0) lines.push([`No items added yet`, 0]);
        if(subtotal < CONFIG.pricing.minOrder){
          const top = round2(CONFIG.pricing.minOrder - subtotal);
          if(top>0) lines.push([`Min order top-up`, top]);
        }
      }
      return lines;
    }

    function recalc(){
      // distance
      const km = haversineKmGoogle(CONFIG.business.base, state.pos);
      q('#distanceKm').textContent = `${km} km`;
      const inArea = km <= CONFIG.business.serviceRadiusKm;
      q('#inArea').textContent = inArea ? 'In service area' : 'Outside service area';
      q('#inArea').className = 'pill ' + (inArea ? 'ok' : 'warn');

      // line items & totals
      const lines = buildLines();
      const body = q('#lines'); body.innerHTML='';
      let subtotal = 0;
      lines.forEach(([label, amt])=>{
        const tr = document.createElement('tr');
        const td1 = document.createElement('td'); td1.textContent = label; tr.appendChild(td1);
        const td2 = document.createElement('td'); td2.className='right'; td2.textContent = money(amt); tr.appendChild(td2);
        body.appendChild(tr);
        subtotal += amt;
      });
      const pickup = pickupFeeForDistance(km);
      const total = round2(Math.max(0, subtotal + pickup));
      q('#pickupFee').textContent = money(pickup);
      q('#grand').textContent = money(total);

      localStorage.setItem('bubbl_state', JSON.stringify({ pos: state.pos, address: q('#addr').value }));
    }

    function syncUIFromConfig(){
      q('#bizName').textContent = CONFIG.business.name;
      q('#year').textContent = new Date().getFullYear();
      q('#p_wf').textContent = money(CONFIG.pricing.washFoldPerKg);
      q('#p_ir').textContent = money(CONFIG.pricing.ironingPerItem);
      q('#p_pb').textContent = money(CONFIG.pricing.pickupFeeBase);
      q('#p_pk').textContent = money(CONFIG.pricing.pickupFeePerKm);
      q('#p_min').textContent = money(CONFIG.pricing.minOrder);
      q('#p_dc_shirt').textContent = money(CONFIG.pricing.dryClean.Shirt);
      q('#p_dc_pants').textContent = money(CONFIG.pricing.dryClean.Pants);
      q('#p_dc_dress').textContent = money(CONFIG.pricing.dryClean.Dress);
      q('#p_dc_suit').textContent = money(CONFIG.pricing.dryClean.Suit);
      q('#p_dc_sheet').textContent = money(CONFIG.pricing.dryClean.Bedsheet);
      q('#rateKg').textContent = money(CONFIG.pricing.washFoldPerKg);
      q('#minOrder').textContent = money(CONFIG.pricing.minOrder);
    }

    function buildItemChips(){
      const itemsHost = q('#items'); itemsHost.innerHTML='';
      const catalog = new Set(['Shirt','Pants','Dress','Suit','Bedsheet','Towel','Curtain']);
      Object.keys(CONFIG.pricing.dryClean).forEach(k=> catalog.add(k));
      [...catalog].forEach(name=>{
        const chip = document.createElement('div'); chip.className='item';
        const label = document.createElement('span'); label.textContent = name; chip.appendChild(label);
        const minus = document.createElement('button'); minus.className='btn secondary'; minus.textContent='‚Äì';
        const input = document.createElement('input'); input.type='number'; input.min='0'; input.step='1'; input.value= state.items[name]||0; input.className='qty';
        const plus = document.createElement('button'); plus.className='btn secondary'; plus.textContent='+';
        minus.onclick = ()=>{ input.value = Math.max(0, parseInt(input.value||'0')-1); state.items[name]=parseInt(input.value)||0; recalc(); };
        plus.onclick  = ()=>{ input.value = (parseInt(input.value||'0')+1); state.items[name]=parseInt(input.value)||0; recalc(); };
        input.oninput = ()=>{ state.items[name]=parseInt(input.value)||0; recalc(); };
        chip.appendChild(minus); chip.appendChild(input); chip.appendChild(plus);
        itemsHost.appendChild(chip);
      });
    }

    function switchBlocks(){
      const svc = q('#service').value; state.service = svc;
      q('#block-washfold').style.display = svc==='washfold' ? 'block' : 'none';
      q('#block-items').style.display   = svc!=='washfold' ? 'block' : 'none';
      recalc();
    }

    function currentOrderJson(){
      const km = haversineKmGoogle(CONFIG.business.base, state.pos);
      const summaryLines = buildLines();
      const subtotal = summaryLines.reduce((s, [,amt])=> s+amt, 0);
      const pickup = pickupFeeForDistance(km);
      const total = round2(Math.max(0, subtotal + pickup));
      return {
        business: CONFIG.business,
        customer: {
          name: q('#custName').value,
          phone: q('#custPhone').value,
          address: q('#addr').value,
          latlng: state.pos,
          pickupAt: q('#pickupAt').value,
          notes: q('#notes').value
        },
        service: state.service,
        items: state.service==='washfold' ? { kg: state.kg, fragile: q('#fragile').value } : state.items,
        pricing: CONFIG.pricing,
        summary: { lines: summaryLines, pickup, total, currency: CONFIG.pricing.currency, symbol: CONFIG.pricing.symbol }
      };
    }

    async function submitOrder(){
      const order = currentOrderJson();
      const status = q('#submitStatus');
      status.textContent = 'Submitting order‚Ä¶';
      try{
        const res = await fetch(CONFIG.backend.submitUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(order)
        });
        if(!res.ok) throw new Error('Server responded ' + res.status);
        const data = await res.json().catch(()=>({ ok:true }));
        status.innerHTML = `‚úÖ Order submitted. Reference: <span class="pill">${(data.id||data.ref||'pending')}</span>`;
      }catch(err){
        console.error(err);
        status.innerHTML = `‚ùå Could not submit. Please call/text us. <span class="muted">(${err.message})</span>`;
      }
    }

    function copyOrderJson(){
      const json = JSON.stringify(currentOrderJson(), null, 2);
      navigator.clipboard.writeText(json).then(()=>{
        alert('Order JSON copied to clipboard');
      });
    }

    function bindEvents(){
      q('#addr').oninput = ()=>{ state.address = q('#addr').value; };
      q('#latlng').onchange = ()=>{
        const [lat,lng] = q('#latlng').value.split(',').map(s=> parseFloat(s.trim()));
        if(isFinite(lat)&&isFinite(lng)){
          state.pos = { lat, lng };
          gmarker.setPosition(state.pos); gmap.setCenter(state.pos); gmap.setZoom(15); recalc();
        }
      };
      q('#service').onchange = switchBlocks;
      q('#kg').oninput = recalc;
      q('#fragile').onchange = recalc;
      q('#btnSubmit').onclick = submitOrder;
      q('#btnCopyJson').onclick = copyOrderJson;
      q('#addItem').onclick = ()=>{
        const name = prompt('Item name (e.g., Blanket)');
        if(!name) return;
        state.items[name] = (state.items[name]||0)+1;
        buildItemChips(); recalc();
      };
      q('#reset').onclick = (e)=>{ e.preventDefault(); localStorage.removeItem('bubbl_state'); location.reload(); };
    }
  </script>
</body>
</html>
